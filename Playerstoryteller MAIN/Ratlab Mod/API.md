# RatLab Server API

This documentation describes the HTTP API exposed by the **RatLab Server** (`ratlab.online`). This is the API used by the Mod to upload data and by the Dashboard to retrieve it.

**Base URL:** `https://ratlab.online` (or `http://localhost:3000` in dev)

## Authentication

*   **Mod Uplink:** Requires `x-stream-key` header (Secret Key generated by the mod).
*   **Dashboard:** Requires `session-id` query parameter or cookie.

## Endpoints

### 1. Game State & Optical View

**POST** `/api/update`

Called by the Mod to push "Fast" and "Slow" tier game state.

*   **Body (JSON):**
    ```json
    {
      "gameState": {
        "pawn_positions": [{"id": 123, "position": {"x":10, "z":20}}], // Ultrafast (10Hz)
        "colonists_light": [...], // Fast (1Hz)
        "colonists_full": [...], // Slow (5s+)
        "resources": {...}
      }
    }
    ```

**POST** `/api/v1/map/things/:sessionId`

Called by the Mod (Fast Tier) to update the Optical View environment.

*   **Body:**
    ```json
    {
      "things": [{"DefName": "Wall", "Position": {...}}],
      "textures": {"Wall": "base64_png_data"}, // Delta compressed
      "focus_zones": [{"x": 10, "z": 20, "radius": 25}] // Areas to clear/update
    }
    ```

**POST** `/api/v1/map/terrain/:sessionId`

Called by the Mod once per session (or on change) to upload the map grid.

*   **Body:**
    ```json
    {
      "width": 250,
      "height": 250,
      "grid": [RLE_Compressed_Int16_Array],
      "palette": ["Soil", "Sand", "WaterDeep"]
    }
    ```

### 2. Adoption System

**GET** `/api/adoptions/:sessionId/status/:username`

Returns adoption status for a viewer.

*   **Response:** `{ "hasAdopted": true, "adoption": { "pawnId": "123" } }`

**POST** `/api/adoptions/:sessionId/request`

Requests adoption of a colonist.

*   **Body:** `{ "username": "User", "nickname": "MyName" }`

**POST** `/api/adoptions/:sessionId/command`

Sends a direct command to the adopted pawn.

*   **Body:**
    ```json
    {
      "username": "User",
      "command": "draft", // or "order", "set_work_priorities"
      "data": { "x": 10, "z": 20 }
    }
    ```

### 3. Viewer Actions

**GET** `/api/actions/:sessionId`

Called by the Mod to fetch pending actions queued by viewers.

*   **Response:**
    ```json
    {
      "success": true,
      "actions": [
        {
          "action": "colonist_command",
          "data": "{ \"type\": \"draft\", \"pawnId\": \"123\" }"
        }
      ]
    }
    ```

### 4. Streaming (WebSocket)

**WS** `/stream`

*   **Protocol:** WebSocket (Socket.io)
*   **Channels:**
    *   `map-things-update`: Optical View updates.
    *   `gamestate-update`: Main dashboard updates.
    *   `queue-update`: Voting queue status.

### 5. Mod Settings (Sync)

**GET** `/api/settings/:sessionId`

Called by the Mod to synchronize remote settings (e.g., enabled events, costs).
